<!DOCTYPE html>
<html lang="en">
<!-- Previous head content remains the same until the script section -->
<script>
    let lastRenderPromise = null;
    let isRendering = false;

    // Single source of truth for rendering content
    async function renderContent(preview, content) {
        if (isRendering) {
            // If already rendering, wait for it to complete
            await lastRenderPromise;
            return;
        }

        isRendering = true;
        preview.innerHTML = marked.parse(content);
        
        // Create a new render promise
        lastRenderPromise = MathJax.typesetPromise([preview])
            .then(() => {
                isRendering = false;
            })
            .catch(err => {
                console.error('MathJax rendering error:', err);
                isRendering = false;
            });

        return lastRenderPromise;
    }

    window.copyImage = async function() {
        const preview = document.getElementById('preview');
        const copyButton = document.getElementById('copyImageBtn');
        
        try {
            // Wait for any ongoing renders to complete
            if (lastRenderPromise) {
                await lastRenderPromise;
            }

            // Create a clone of the preview element
            const clone = preview.cloneNode(true);
            
            // Wait for the canvas to be created
            const canvas = await html2canvas(preview, {
                scale: 2,
                useCORS: true,
                allowTaint: true,
                logging: false
            });

            // Convert to blob and copy
            const blob = await new Promise(resolve => canvas.toBlob(resolve));
            await navigator.clipboard.write([
                new ClipboardItem({ 'image/png': blob })
            ]);

            showButtonFeedback(copyButton, 'Copied!');
        } catch (err) {
            console.error('Error copying image:', err);
            copyButton.textContent = 'Error!';
            setTimeout(() => {
                copyButton.textContent = 'Copy Image';
            }, 2000);
        }
    };

    window.onload = function() {
        const editor = document.getElementById('editor');
        const preview = document.getElementById('preview');
        const titleInput = document.getElementById('title');
        const errorMessage = document.getElementById('errorMessage');

        async function updatePreview() {
            await renderContent(preview, editor.value);
        }

        // Debounce the preview update
        let updateTimeout;
        editor.addEventListener('input', () => {
            clearTimeout(updateTimeout);
            updateTimeout = setTimeout(updatePreview, 300);
        });

        // Initial render
        updatePreview();

        // Rest of your event handlers...
        function validateTitle() {
            const isEmpty = titleInput.value.trim() === '';
            errorMessage.style.display = isEmpty ? 'block' : 'none';
            const buttonsToToggle = [
                document.getElementById('copyLinkBtn'),
                document.getElementById('shareableLinkBtn')
            ];
            buttonsToToggle.forEach(button => button.disabled = isEmpty);
        }

        titleInput.addEventListener('input', validateTitle);
        validateTitle();

        // Previous button handlers remain the same...
    };
</script>
</html>
